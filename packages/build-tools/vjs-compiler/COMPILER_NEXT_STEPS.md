# VJS Compiler - Next Steps

This document outlines the next phases of work for the VJS compiler, focusing on improving CSS compilation quality, context-aware path resolution, and ensuring full feature parity between React+Tailwind source and compiled outputs.

**Last Updated**: 2025-10-06

---

## Table of Contents

1. [Recent Discoveries](#recent-discoveries)
2. [Phase 6: CSS Compilation Issues](#phase-6-css-compilation-issues)
3. [Phase 7: Context-Aware Path Resolution](#phase-7-context-aware-path-resolution)
4. [Phase 8: Testing & Validation](#phase-8-testing--validation)
5. [Future Enhancements](#future-enhancements)

---

## Recent Discoveries

### HTML/Web Component Compilation Issues

During smoke testing of compiled HTML/web component skins (2025-10-06), several CSS compilation discrepancies were discovered between:

- **React + Tailwind (Original)**: Source skins using Tailwind classes
- **HTML + Compiled Tailwind CSS (Compiled)**: Web components with inline vanilla CSS generated by `skin-web-component-tailwind` pipeline
- **HTML + Hand-written CSS (Reference)**: Hand-written web component in `packages/html/html/src/skins/media-skin-default.ts`

### Issue Summary

| Issue | React+Tailwind | HTML Compiled | HTML Hand-written | Status |
|-------|----------------|---------------|-------------------|--------|
| Overlay gradient visible when paused | ‚úÖ Yes | ‚ùå No | ‚ùå No | üî¥ Critical |
| Fullscreen icon animates on hover | ‚úÖ Yes (SVG paths with classes) | ‚ùå No | ‚ùå No | üü° Medium |
| Glass-morphism styling | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No (basic styles) | ‚úÖ Working |
| Control bar visibility/animation | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Working |

### Key Finding

The compiled skins are **more accurate** than the hand-written reference skin, but still missing some features present in the React+Tailwind original. This suggests:

1. The compiler is successfully translating most Tailwind classes to CSS
2. Some edge cases in CSS compilation need investigation
3. SVG-specific class handling may need special consideration

---

## Phase 6: CSS Compilation Issues

### Priority: üî¥ Critical

### 6.1 Missing Overlay Gradient When Paused

**Description**: The overlay gradient that appears when the video is paused is not visible in the compiled HTML skins, but works correctly in the React+Tailwind version.

**Observations**:
- React+Tailwind: Visible dark gradient overlay from bottom to top when paused
- HTML Compiled: Gradient CSS appears to be generated but doesn't render
- HTML Hand-written: No gradient implemented (uses solid background in control bar)

**Visual Evidence**:
- `react-frosted-original-paused.png`: Shows gradient overlay ‚úÖ
- `compiled-default-paused.png`: No visible gradient ‚ùå
- `default-handwritten-paused.png`: No gradient (expected) ‚ùå

**Suspected Causes**:
1. **Selector specificity**: The `:has()` pseudo-class selector may not be specific enough
2. **Z-index stacking**: Overlay may be behind other elements
3. **Opacity calculation**: Opacity transitions may be incorrectly compiled
4. **Pointer events**: `pointer-events: none` may be interfering

**Source Tailwind Classes** (from React):
```typescript
Overlay: cn(
  'opacity-0 delay-500',
  'absolute inset-0 pointer-events-none z-10',
  'bg-gradient-to-t from-black/50 via-black/20 to-transparent',
  'transition-opacity ease-out',
  'backdrop-blur-3xl backdrop-saturate-150 backdrop-brightness-90',
  'rounded-[inherit]',
  'has-[+.controls_[data-paused]]:opacity-100 has-[+.controls_[data-paused]]:delay-0',
  'group-hover/root:opacity-100 group-hover/root:delay-0',
),
```

**Investigation Steps**:
1. Compare generated CSS between React and compiled versions
2. Use browser DevTools to inspect element visibility and stacking
3. Check if `:has()` selector is being transformed correctly
4. Verify gradient generation (from-black/50, via-black/20, to-transparent)
5. Test in isolation with simplified HTML

**Expected Fix Location**:
- `src/cssProcessing/tailwindToCSSModules.ts` - CSS generation
- `src/styleProcessing/tailwindAST.ts` - Tailwind AST parsing
- `src/pipelines/skinToWebComponentInlineTailwind.ts` - Pipeline processing

---

### 6.2 Fullscreen Icon Hover Animation Missing

**Description**: In the React+Tailwind version, the fullscreen icon's arrow paths animate on hover (arrows move outward/inward). This animation is missing in the compiled version.

**Key Insight**: These animations are defined as **classes on SVG `<path>` elements**, not on the button container:

```tsx
// React source (icon definition)
export function MediaFullscreenEnterIcon({ className }: { className?: string }) {
  return (
    <svg className={className} /* ... */>
      <path className="arrow-1" /* ... */ />  {/* ‚Üê Class on path! */}
      <path className="arrow-2" /* ... */ />  {/* ‚Üê Class on path! */}
    </svg>
  );
}

// React styles
FullscreenEnterIcon: cn(
  'group-hover/button:[&_.arrow-1]:-translate-x-px',
  'group-hover/button:[&_.arrow-1]:-translate-y-px',
  'group-hover/button:[&_.arrow-2]:translate-x-px',
  'group-hover/button:[&_.arrow-2]:translate-y-px',
),
```

**Observations**:
- React+Tailwind: Arrows animate smoothly on hover ‚úÖ
- HTML Compiled: No animation on hover ‚ùå
- The CSS for these transforms **is generated** in the compiled output
- The SVG paths in compiled output **do not have class attributes**

**Compiled CSS Output** (verified present):
```css
@media (hover: hover) {
  .button:hover media-fullscreen-enter-icon .arrow-1 {
    translate: -1px 0px;
  }
  .button:hover media-fullscreen-enter-icon .arrow-1 {
    translate: 0px -1px;
  }
  /* ... more rules ... */
}
```

**Root Cause**: The compiler is generating CSS that targets `.arrow-1` and `.arrow-2` classes, but the SVG serializer is not preserving these class attributes on the `<path>` elements when converting from React to HTML.

**Investigation Steps**:
1. Check React component definition for icon SVG structure
2. Verify serializer (`src/serializer.ts`) handles class attributes on SVG children
3. Check if `ClassAttributeProcessor` is stripping necessary classes from SVG paths
4. Test if manually adding classes to paths in HTML makes animation work

**Expected Fix Location**:
- `src/serializer.ts` - JSX to HTML conversion
- `src/attributeProcessing/ClassAttributeProcessor.ts` - Class attribute handling
- May need special handling for SVG child element classes

---

### 6.3 Compiler Application Improvements

**Status**: üü° Medium Priority

**Description**: Ensure the compiler appropriately applies CSS transformations across all pipelines and output formats, with special attention to edge cases.

**Tasks**:

1. **Audit all pipelines for consistency**:
   - `skin-react-css-modules`
   - `skin-react-inline`
   - `skin-web-component-tailwind`
   - Ensure same CSS quality across all outputs

2. **Test with more complex selectors**:
   - Multiple `:has()` combinators
   - Nested pseudo-classes
   - Attribute selectors with special characters

3. **Verify state-based styling**:
   - `[data-paused]`
   - `[data-fullscreen]`
   - `[data-volume-level]`
   - All data-attribute-based state changes

4. **Cross-browser testing**:
   - Safari (webkit)
   - Firefox (gecko)
   - Chrome (blink)
   - Verify `color-mix()`, `backdrop-filter`, `:has()` support

---

## Phase 7: Context-Aware Path Resolution

### Priority: üü° Medium

### 7.1 Intelligent Import Path Calculation

**Description**: The compiler currently generates incorrect import paths when output files are nested in directories. Paths need to be calculated based on:

- Source file location
- Output file location
- Whether output is within the same package or a different package
- Framework transformation (React ‚Üí HTML requires package change: `@vjs-10/react` ‚Üí `@vjs-10/html`)

**Current Behavior**:
```typescript
// Generated (WRONG - in packages/html/html/src/skins/compiled/inline/):
import { MediaSkin } from '../media-skin';  // ‚ùå Goes to skins/media-skin (doesn't exist)

// Correct:
import { MediaSkin } from '../../../media-skin';  // ‚úÖ Goes to src/media-skin
```

**Requirements**:

1. **Relative Path Depth Calculation**:
   ```typescript
   function calculateRelativePath(
     sourceFile: string,
     outputFile: string,
     targetImport: string
   ): string {
     // Calculate directory depth difference
     // Adjust relative path accordingly
   }
   ```

2. **Package Boundary Detection**:
   ```typescript
   function isInPackageSource(filePath: string, packageRoot: string): boolean {
     // Check if file is in src/ or elsewhere in package
   }
   ```

3. **Framework-Specific Package Mapping**:
   ```typescript
   const packageMappings = {
     'react-to-html': {
       '@vjs-10/react': '@vjs-10/html',
       '@vjs-10/react-icons': '@vjs-10/html-icons',
       '@vjs-10/react-media-store': '@vjs-10/html' // different mapping!
     }
   };
   ```

**Example Transformations**:

| Source Import | Source Location | Output Location | Expected Import |
|---------------|-----------------|-----------------|-----------------|
| `'../media-skin'` | `packages/react/react/src/skins/default/` | `packages/html/html/src/skins/compiled/inline/` | `'../../../media-skin'` |
| `'@vjs-10/react'` | Any | `packages/html/html/src/` | `'@vjs-10/html'` |
| `'@vjs-10/react-icons'` | Any | `packages/html/html/src/` | `'@vjs-10/html-icons'` |

**Implementation Location**:
- New module: `src/utils/pathResolver.ts`
- Called from: `src/transforms/importTransformers.ts`
- Configuration: `src/config/types.ts` (add `outputPath` field)

---

### 7.2 Component Reference Resolution

**Description**: When transforming React components to HTML, need to resolve component references to the correct custom element names.

**Example**:
```tsx
// React source
import { MediaContainer } from '@vjs-10/react';

// HTML output
<media-container></media-container>
```

**Challenges**:
- Component name to element name mapping (PascalCase ‚Üí kebab-case)
- Handling sub-exports (e.g., `TimeRange.Root` ‚Üí `media-time-range-root`)
- Cross-package component references

**Implementation**:
- Extend `src/transformer.ts` with component registry
- Add custom element name resolution
- Handle compound component patterns

---

## Phase 8: Testing & Validation

### Priority: üü° Medium

### 8.1 Visual Regression Testing

**Description**: Automated testing to ensure compiled skins match React originals visually.

**Approach**:
1. Use Playwright for screenshot comparison
2. Test matrix: Browser √ó Skin √ó State (paused/playing/hover)
3. Pixel-diff threshold for pass/fail
4. Run on CI

**Test Scenarios**:
- [ ] Default skin - paused state - overlay gradient visible
- [ ] Default skin - hover state - controls visible
- [ ] Default skin - hover fullscreen button - icon animates
- [ ] Toasted skin - paused state - controls slide in
- [ ] Toasted skin - hover volume - slider expands

**Files**:
- `packages/build-tools/vjs-compiler/test/visual-regression.test.ts`
- Screenshots: `packages/build-tools/vjs-compiler/test/screenshots/`

---

### 8.2 CSS Equivalency Testing

**Status**: ‚úÖ Mostly Complete (42/42 tests passing)

**Additional Tests Needed**:
- [ ] SVG child element class preservation
- [ ] `:has()` selector compilation
- [ ] Overlay gradient generation
- [ ] State-based animations (hover, focus, active)
- [ ] Data attribute selectors

**Implementation**:
- Add to `packages/build-tools/vjs-compiler/test/outputValidation.test.ts`

---

## Future Enhancements

### Low Priority / Nice-to-Have

#### 9.1 Source Maps for CSS

**Description**: Generate source maps that trace compiled CSS back to original Tailwind utilities.

**Use Cases**:
- Debugging why specific styles are/aren't applied
- Understanding CSS provenance
- Browser DevTools integration

**Implementation**:
- Use `postcss` source map support
- Track transformations through pipeline
- Output `.css.map` files

---

#### 9.2 Dry-Run Mode

**Description**: Preview compilation output without writing files.

**Benefits**:
- Faster iteration during development
- CI integration (validate without artifacts)
- Diff-based testing

**CLI**:
```bash
vjs-compiler compile input.tsx --dry-run --format json
```

---

#### 9.3 Watch Mode

**Description**: Re-compile on file changes.

**Implementation**:
- Use `chokidar` for file watching
- Incremental compilation (cache unchanged files)
- Terminal UI with compilation status

**CLI**:
```bash
vjs-compiler compile input.tsx --watch
```

---

## Implementation Order

### Recommended Sequence

1. **Phase 6.1 - Fix overlay gradient** (Critical for visual parity)
2. **Phase 6.2 - Fix SVG icon animation** (Medium priority, visible issue)
3. **Phase 7.1 - Path resolution** (Prevents manual fixes after compilation)
4. **Phase 8.1 - Visual testing** (Prevents regressions)
5. **Phase 7.2 - Component resolution** (Nice-to-have, helps with complex components)
6. **Future enhancements** - As needed

---

## Testing Checklist

Before considering compilation "production-ready":

### Visual Parity
- [ ] Overlay gradient shows when paused (React vs Compiled)
- [ ] Fullscreen icon animates on hover (React vs Compiled)
- [ ] All hover states work (buttons, sliders)
- [ ] All focus states work (keyboard navigation)
- [ ] All data-attribute states work (paused, muted, fullscreen)

### Code Quality
- [ ] No manual path fixes needed after compilation
- [ ] No manual class attribute fixes needed
- [ ] Generated code passes linting
- [ ] No CSS specificity conflicts

### Cross-Browser
- [ ] Chrome/Edge (Blink)
- [ ] Firefox (Gecko)
- [ ] Safari (WebKit)

### Performance
- [ ] Bundle size reasonable (<100KB for skin)
- [ ] No CSS duplication
- [ ] No unused CSS

---

## Notes

### Known Good State

**Commit**: `5f7462d` - "feat(html): regenerate compiled skins with Tailwind CSS"

This commit has:
- ‚úÖ Tailwind CSS successfully compiled to inline vanilla CSS
- ‚úÖ Glass-morphism styling working (backdrop-blur, translucency)
- ‚úÖ Control bar animations working (scale, opacity, delays)
- ‚ùå Overlay gradient missing
- ‚ùå Icon hover animations missing

### Related Files

**Compiler Core**:
- `src/cssProcessing/tailwindToCSSModules.ts` - CSS transformation
- `src/serializer.ts` - React to HTML conversion
- `src/transformer.ts` - AST transformation

**Pipelines**:
- `src/pipelines/skinToWebComponentInlineTailwind.ts` - Web component + Tailwind CSS pipeline
- `src/pipelines/skinToReactInline.ts` - React + inline CSS pipeline

**Test Files**:
- `test/outputValidation.test.ts` - CSS equivalency tests
- `test/integration.test.ts` - End-to-end tests

**Demo Apps**:
- `examples/html-demo/` - HTML/web component smoke testing
- `examples/react-demo/` - React reference implementation

---

## Getting Help

If working on these tasks:

1. **Check existing tests**: `npm run test` in vjs-compiler package
2. **Run compiler manually**: `packages/build-tools/vjs-compiler/dist/cli.js compile <input> --type skin --format web-component --css tailwind`
3. **Check browser console**: Look for CSS errors, specificity issues
4. **Use DevTools**: Inspect generated elements, check computed styles
5. **Compare outputs**: Diff compiled CSS against expected CSS

---

Last Updated: 2025-10-06
